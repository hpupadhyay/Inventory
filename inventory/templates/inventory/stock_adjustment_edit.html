{% extends "inventory/base.html" %}
{% load crispy_forms_tags static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold mb-6">Edit Stock Adjustment (ID: {{ object.pk }})</h2>

    <form method="post" id="adjustment-form">
        {% csrf_token %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-bold mb-4">Adjustment Details</h3>
            {% if header_form.non_field_errors %}
            <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg">
                {{ header_form.non_field_errors }}
            </div>
            {% endif %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {{ header_form|crispy }}
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-bold mb-4">Items to Adjust</h3>
            {{ item_formset.management_form }}
            {% if item_formset.non_form_errors %}
            <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg">
                {{ item_formset.non_form_errors }}
            </div>
            {% endif %}
            
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 px-3">Item</th>
                            <th class="text-left py-2 px-3">Warehouse</th>
                            <th class="text-left py-2 px-3">Type</th>
                            <th class="text-left py-2 px-3">Quantity</th>
                            <th class="text-left py-2 px-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="item-form-list">
                        {% for form in item_formset %}
                        <tr class="item-form border-b {% if form.errors %}bg-red-50{% endif %}">
                            <td class="py-2 px-3">{{ form.item|as_crispy_field }}</td>
                            <td class="py-2 px-3">{{ form.warehouse|as_crispy_field }}</td>
                            <td class="py-2 px-3">{{ form.adjustment_type|as_crispy_field }}</td>
                            <td class="py-2 px-3">{{ form.quantity|as_crispy_field }}</td>
                            <td class="py-2 px-3 align-bottom whitespace-nowrap">
                                {% if form.instance.pk %}
                                {{ form.DELETE|as_crispy_field }}
                                {% endif %}
                                <button type="button" class="remove-item-form text-red-500 hover:text-red-700 font-bold">
                                    Remove
                                </button>
                            </td>
                            {% if form.errors %}
                            <td colspan="5" class="p-2 text-red-600 text-sm">
                                {% for field, errors in form.errors.items %}
                                    {% if field != "DELETE" %}
                                        {{ field|title }}: {{ errors|join:", " }}
                                    {% endif %}
                                {% endfor %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="button" id="add-item-form" class="mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded hover:bg-green-600">
                Add Another Item
            </button>
        </div>

        <div class="flex justify-between mt-8">
            <a href="{% url 'stock_adjustment_report' %}" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600">
                Cancel
            </a>
            <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">
                Update Adjustment
            </button>
        </div>
    </form>
</div>

<div id="empty-form" style="display:none;">
    <tr class="item-form border-b">
        <td class="py-2 px-3">{{ item_formset.empty_form.item|as_crispy_field }}</td>
        <td class="py-2 px-3">{{ item_formset.empty_form.warehouse|as_crispy_field }}</td>
        <td class="py-2 px-3">{{ item_formset.empty_form.adjustment_type|as_crispy_field }}</td>
        <td class="py-2 px-3">{{ item_formset.empty_form.quantity|as_crispy_field }}</td>
        <td class="py-2 px-3 align-bottom">
            <button type="button" class="remove-item-form text-red-500 hover:text-red-700 font-bold">
                Remove
            </button>
        </td>
    </tr>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        function initializeSelect2ForRow(row) {
            const itemSelect = row.find('select[id$="-item"]');
            row.find('select:not([id$="-item"])').select2({
                theme: "classic",
                width: '100%'
            });

            itemSelect.select2({
                theme: "classic",
                width: '100%',
                placeholder: 'Type to search items...',
                ajax: {
                    url: "{% url 'get_items_api' %}",
                    dataType: 'json',
                    delay: 250,
                    data: (params) => ({
                        term: params.term
                    }),
                    processResults: (data) => ({
                        results: data.results || []
                    })
                }
            });
        }

        $('#add-item-form').click(function() {
            const totalForms = $('#id_items-TOTAL_FORMS').val();
            const newForm = $('#empty-form').html().replace(/__prefix__/g, totalForms);
            $('#item-form-list').append(newForm);
            $('#id_items-TOTAL_FORMS').val(parseInt(totalForms) + 1);
            
            const newRow = $('#item-form-list tr').last();
            initializeSelect2ForRow(newRow);
        });

        $('#item-form-list').on('click', '.remove-item-form', function() {
            const row = $(this).closest('tr');
            const deleteInput = row.find('input[id$="-DELETE"]');
            
            if (deleteInput.length) {
                deleteInput.prop('checked', true);
                row.hide();
            } else {
                row.remove();
            }
        });

        $('#adjustment-form').on('submit', function(e) {
            let valid = true;
            $('.item-form:visible').each(function() {
                const row = $(this);
                if (!row.find('select[id$="-item"]').val() ||
                    !row.find('select[id$="-warehouse"]').val() ||
                    !row.find('select[id$="-adjustment_type"]').val() ||
                    !row.find('input[id$="-quantity"]').val()) {
                    valid = false;
                    row.addClass('bg-red-50');
                }
            });
            
            if (!valid) {
                e.preventDefault();
                alert('Please fill all required fields in all item rows.');
            }
        });

        $('.item-form').each(function() {
            initializeSelect2ForRow($(this));
        });
    });
</script>
{% endblock %}